---
title: java多线程
date: 2017-09-01 13:51:24
tags:
- 多线程
categories:
- java基础
---
# java多线程

多线程是多个线程竞争CPU，就绪状态的线程进行排队，当CPU选中线程就执行一个时间片，之后再次进行竞争。

在单个单核CPU上多线程运行不会出现共享内存问题，但是随着多核多个CPU的出现，多线程运行在不同的运行内存中，并发操作共享内存会产生一系列并发问题需要解决。

<!--more-->

- 优点：

  - 适当的提高程序的执行效率（多个线程同时执行）
  - 适当的提高了资源利用率（CPU、内存等）
- 缺点：
  - 占用一定的内存空间。
  - 线程越多CPU的调度开销越大。
  - 程序的复杂度会上升。

## 多线程模式

- 并行线程模式：

  常用的并发线程模式，将任务使用多个线程并行执行处理

  - 优点
    - 提升简单，只需要控制并发线程的数量进行操控，一般通过压测找到最合适的并发量
    - 更适用于尽量少操作共享变量并且相互之间独立的多线程
  - 缺点
    - 操作共享变量的时候逻辑变复杂，如果使用锁机制会导致性能下降
    - 共享变量需要每次去操作主内存中变量，无法使用线程空间中变量，性能偏低
    - 共享变量使用不可变对象或者使用多个版本控制又无法达到线程之间一致性
    - 多个线程之间无法保证运行的顺序性

  ![image](http://omdq6di7v.bkt.clouddn.com/17-9-29/34093455.jpg)

- 事件驱动模式：

  将一个任务分解多步，每个步骤由一个线程去执行，类似生产线,会有多个生产线并存，并发生交叉，上个执行完毕后通过事件监听通知下个环节线程进行操作，各环节线程之间不存在并发操作共享变量情况

  ![image](http://omdq6di7v.bkt.clouddn.com/17-9-30/15328264.jpg)

  每个环节中间加入channel，解耦两个环节线程

  ![image](http://omdq6di7v.bkt.clouddn.com/17-9-29/89911687.jpg)

  - 优点
    - 各个环节线程不涉及同时操作共享变量，不需考虑并发问题
    - 直接使用线程工作空间copy的变量，只需最后操作主内存变量，性能提高
    - 单线程模式下可以实现更多的算法和使用更多的数据结构来提升性能
    - 实现任务拆分后的顺序执行
  - 缺点
    - 任务被拆分执行后可能在不同应用的不同线程执行，观察任务执行轨迹会比较麻烦
    - 需要一系列的嵌套的事件回调方法，代码逻辑复杂


## 线程阻塞到运行性能问题

对于单核CPU来说（对于多核CPU，此处就理解为一个核），CPU在一个时刻只能运行一个线程，当在运行一个线程的过程中转去运行另外一个线程，这个叫做线程上下文切换。由于可能当前线程的任务并没有执行完毕，所以在切换时需要保存线程的运行状态(程序计数器、CPU寄存器状态)，以便下次重新切换回来时能够继续切换之前的状态运行。对于线程的上下文切换实际上就是存储和恢复CPU状态的过程，它使得线程执行能够从中断点恢复执行。每次大约需要占用8w多CPU时间周期

上下文切换会带来直接和间接两种因素影响程序性能的消耗. 

- 直接消耗包括: CPU寄存器需要保存和加载, 系统调度器的代码需要执行, TLB实例需要重新加载, CPU 的pipeline需要刷掉; 
- 间接消耗指的是多核的cache之间得共享数据, 间接消耗对于程序的影响要看线程工作区操作数据的大小

引起上下文切换的原因大概有以下几种: 

1. 当前执行任务的时间片用完之后, 系统CPU正常调度下一个任务 
2. 当前执行任务碰到IO阻塞, 调度器将挂起此任务, 继续下一任务 
3. 多个任务抢占锁资源, 当前任务没有抢到,被调度器挂起, 继续下一任务 
4. 用户代码挂起当前任务, 让出CPU时间